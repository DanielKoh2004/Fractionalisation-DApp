<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Panel — RealEstate dApp</title>
<style>
  body{font-family:Inter,Arial;margin:0;background:#f6fbff}
  header{background:#fff;padding:14px 24px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
  .logo{font-weight:bold;font-size:18px}
  .btn{padding:8px 14px;background:#0b63ff;color:#fff;border:none;border-radius:6px;cursor:pointer;text-decoration:none}
  .nav-link {
    transition: color 0.2s, box-shadow 0.2s;
    border-radius: 6px;
    padding: 4px 10px;
    text-decoration: none;
    color: #4636e3;
    font-weight: 500;
    font-size: 1.08rem;
  }
  .nav-link:hover {
    background: #edeaff;
    color: #0b63ff;
    box-shadow: 0 2px 8px rgba(70,54,227,0.10);
  }
  .btn-login {
    transition: color 0.2s, box-shadow 0.2s;
    background: #0b63ff;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 8px 18px;
    font-size: 1.08rem;
    cursor: pointer;
    font-weight: 500;
    text-decoration: none;
    margin-left: 8px;
  }
  .btn-login:hover {
    background: #4636e3;
    color: #fff;
    box-shadow: 0 2px 8px rgba(70,54,227,0.10);
  }
  .admin-container {max-width:1000px;margin:48px auto 0 auto;padding:32px;background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(70,54,227,0.08);}
  .admin-title {font-size:2.1rem;font-weight:700;color:#4636e3;margin-bottom:18px;}
  .admin-desc {font-size:1.15rem;color:#444;line-height:1.6;margin-bottom:24px;}
  .card{background:#f6f5ff;padding:24px;border-radius:14px;box-shadow:0 2px 12px rgba(70,54,227,0.07);margin-bottom:32px;}
  input,textarea,button{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #e6eefc;box-sizing:border-box;}
  button{background:#4636e3;color:#fff;font-weight:500;cursor:pointer;transition:background 0.2s;}
  button:hover{background:#0b63ff;}
  h2{margin:6px 0}
  a{color:#0b63ff}
</style>
</head>
<body>
  <header>
    <div class="logo">RealEstate dApp</div>
    <div style="display:flex;align-items:center;gap:32px;">
      <nav style="display:flex;align-items:center;gap:24px;">
        <a href="index.html" class="nav-link">Home</a>
        <a href="marketplace.html" class="nav-link">Marketplace</a>
        <a href="profile.html" class="nav-link" id="profileBtn" style="display:none;">Profile</a>
        <a href="admin.html" class="nav-link" id="adminBtn" style="display:none;">Admin</a>
        <a href="about_us.html" class="nav-link">About Us</a>
        <a href="#" class="btn-login" id="loginBtn">Login</a>
        <a href="#" class="btn-login" id="logoutBtn" style="display:none;">Logout</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="admin-container">
      <div class="admin-title">Admin Panel</div>
      <div class="admin-desc">
        Welcome, Admin! Here you can list new properties for fractional ownership and manage dividends.<br>
        <b>Note:</b> All property trading is powered by Ethereum blockchain smart contracts for secure, transparent transactions.
      </div>
      <div class="card">
        <h3>List New Property</h3>
        <input id="title" placeholder="Property name (e.g. Damansara Villa)" />
        <input id="address" placeholder="Address (e.g. No. 12, Jalan Damansara, 47800 Petaling Jaya, Selangor)" />
        <input id="rentalYield" type="number" step="0.01" placeholder="Rental Yield (%)" />
        <input id="annualReturn" type="number" step="0.01" placeholder="Projected Annual Return (%)" />
        <input id="totalShares" type="number" placeholder="Total shares (e.g. 10000)" />
        <input id="sharePrice" type="number" step="0.0001" placeholder="Price per share (ETH)" />
        <label for="imageUpload">House image:</label>
        <input id="imageUpload" type="file" accept="image/*" />
        <img id="previewImg" src="" alt="Preview" style="display:none;width:100%;max-width:320px;margin:12px 0;border-radius:12px;" />
        <button id="createProp">Create property</button>
        <div id="propMsg" class="small"></div>
      </div>
      <div class="card">
        <h3>Delete Property</h3>
        <div id="deletePropList"></div>
        <div id="deleteMsg" class="small"></div>
      </div>
    </div>
  </main>

  <footer style="background:#fff;border-top:1px solid #e3e6fd;padding:24px 0;text-align:center;margin-top:48px;font-size:1.08rem;color:#444;">
    <div>&copy; 2025 RealEstate dApp. All rights reserved.</div>
  </footer>

<script>
function renderAuth() {
  const userStr = localStorage.getItem('currentUser');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const profileBtn = document.getElementById('profileBtn');
  const adminBtn = document.getElementById('adminBtn');
  if (userStr) {
    const user = JSON.parse(userStr);
    loginBtn.style.display = 'none';
    logoutBtn.style.display = '';
    if (user.isAdmin) {
      adminBtn.style.display = '';
      profileBtn.style.display = 'none';
    } else {
      adminBtn.style.display = 'none';
      profileBtn.style.display = '';
    }
  } else {
    loginBtn.style.display = '';
    logoutBtn.style.display = 'none';
    profileBtn.style.display = 'none';
    adminBtn.style.display = 'none';
  }
}

document.getElementById('loginBtn').addEventListener('click', function(e) {
  e.preventDefault();
  window.location.href = 'login.html';
});

document.getElementById('logoutBtn').addEventListener('click', function(e) {
  e.preventDefault();
  localStorage.removeItem('currentUser');
  renderAuth();
  window.location.reload();
});

window.addEventListener('DOMContentLoaded', renderAuth);
const cu = JSON.parse(localStorage.getItem('currentUser')||'null');
if (!cu || !cu.isAdmin) { alert('Admin access required'); window.location.href='index.html'; }

function refreshPropSelect(){
  const props = JSON.parse(localStorage.getItem('properties')||'[]');
  // If divProperty select exists, update it (for legacy code)
  const sel = document.getElementById('divProperty');
  if (sel) sel.innerHTML = '<option value="">— choose property —</option>' + props.map(p=>`<option value="${p.id}">${p.title}</option>`).join('');
}
refreshPropSelect();

function renderDeletePropList() {
  const props = JSON.parse(localStorage.getItem('properties')||'[]');
  const container = document.getElementById('deletePropList');
  if (!container) return;
  if (props.length === 0) {
    container.innerHTML = '<div>No properties available.</div>';
    return;
  }
  container.innerHTML = props.map(p => `
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:12px;background:#fff;padding:10px;border-radius:8px;box-shadow:0 1px 6px rgba(70,54,227,0.07);">
      <img src="${p.image}" alt="${p.title}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;">
      <div style="flex:1;">
        <div style="font-weight:600;color:#4636e3;">${p.title}</div>
        <div style="font-size:0.98rem;color:#444;">${p.address}</div>
      </div>
      <button class="btn" style="background:#e34c4c;" onclick="deleteProperty(${p.id})">Delete</button>
    </div>
  `).join('');
}
renderDeletePropList();

function deleteProperty(id) {
  let props = JSON.parse(localStorage.getItem('properties')||'[]');
  const idx = props.findIndex(p=>p.id===id);
  if (idx === -1) return;
  const propTitle = props[idx].title;
  props.splice(idx,1);
  localStorage.setItem('properties', JSON.stringify(props));
  document.getElementById('deleteMsg').innerText = `Property "${propTitle}" deleted.`;
  renderDeletePropList();
}

document.getElementById('imageUpload').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    document.getElementById('previewImg').src = evt.target.result;
    document.getElementById('previewImg').style.display = '';
  };
  reader.readAsDataURL(file);
});

document.getElementById('createProp').addEventListener('click', ()=>{
  const title = document.getElementById('title').value.trim();
  const address = document.getElementById('address').value.trim();
  const rentalYield = Number(document.getElementById('rentalYield').value);
  const annualReturn = Number(document.getElementById('annualReturn').value);
  const totalShares = Number(document.getElementById('totalShares').value);
  const sharePrice = Number(document.getElementById('sharePrice').value);
  const imageInput = document.getElementById('imageUpload');
  let image = '';
  if (imageInput.files && imageInput.files[0]) {
    const reader = new FileReader();
    reader.onload = function(evt) {
      image = evt.target.result;
      saveProperty();
    };
    reader.readAsDataURL(imageInput.files[0]);
  } else {
    saveProperty();
  }
  function saveProperty() {
    if (!title||!address||!rentalYield||!annualReturn||!totalShares||!sharePrice||!image) {
      document.getElementById('propMsg').innerText='Complete all fields and upload image.';
      return;
    }
    const props = JSON.parse(localStorage.getItem('properties')||'[]');
    const id = props.length?Math.max(...props.map(p=>p.id))+1:1;
    const p = {
      id,
      title,
      address,
      image,
      rentalYield,
      annualReturn,
      totalShares,
      availableShares: totalShares,
      sharePrice
    };
    props.push(p); localStorage.setItem('properties', JSON.stringify(props));
    document.getElementById('propMsg').innerText='Property created.';
    refreshPropSelect();
    window.location.href = 'marketplace.html';
  }
});

document.getElementById('distributeBtn').addEventListener('click', ()=>{
  const amount = Number(document.getElementById('divAmount').value);
  const propId = Number(document.getElementById('divProperty').value);
  if (!amount||!propId) return document.getElementById('divMsg').innerText='Provide amount and property.';
  const ownership = JSON.parse(localStorage.getItem('ownership')||'[]');
  const owners = ownership.filter(o=>o.propertyId===propId && o.shares>0);
  const totalShares = owners.reduce((s,o)=>s+o.shares,0);
  if (totalShares===0) return document.getElementById('divMsg').innerText='Property has no shareholders.';
  const transactions = JSON.parse(localStorage.getItem('transactions')||'[]');
  const timestamp = new Date().toISOString();
  owners.forEach(o=>{
    const share = o.shares;
    const payout = Math.round((amount * (share/totalShares))*100)/100;
    transactions.push({id:transactions.length+1,type:'dividend',propertyId:propId,userId:o.userId,amount:payout,timestamp});
  });
  localStorage.setItem('transactions', JSON.stringify(transactions));
  document.getElementById('divMsg').innerText=`Distributed $${amount} to ${owners.length} owners.`;
});
</script>
</body>
</html>
