<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Marketplace â€” RealEstate dApp</title>
<style>
  body{font-family:Inter,Arial;margin:0;background:#f6fbff}
  .row{display:flex;gap:12px}
  .card{background:#fff;padding:14px;border-radius:10px;border:1px solid #eef6ff;flex:1}
  input,button,select{width:100%;padding:8px;margin:6px 0;border-radius:8px;border:1px solid #e6eefc}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #f0f4fb;text-align:left}
  a{color:#0b63ff}
  header{background:#fff;padding:14px 24px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,0.05);}
  .logo{font-weight:bold;font-size:18px;}
  .nav-right{display:flex;align-items:center;gap:18px;}
  .nav-link {
    transition: color 0.2s, box-shadow 0.2s;
    border-radius: 6px;
    padding: 4px 10px;
    text-decoration: none;
    color: #4636e3;
    font-weight: 500;
    font-size: 1.08rem;
  }
  .nav-link:hover {
    background: #edeaff;
    color: #0b63ff;
    box-shadow: 0 2px 8px rgba(70,54,227,0.10);
  }
  .btn-login {
    transition: color 0.2s, box-shadow 0.2s;
    background: #0b63ff;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 8px 18px;
    font-size: 1.08rem;
    cursor: pointer;
    font-weight: 500;
    text-decoration: none;
    margin-left: 8px;
  }
  .btn-login:hover {
    background: #4636e3;
    color: #fff;
    box-shadow: 0 2px 8px rgba(70,54,227,0.10);
  }
  .profile {
    width:36px;height:36px;border-radius:50%;background:#0b63ff;color:#fff;
    display:flex;align-items:center;justify-content:center;font-weight:bold;cursor:pointer;text-decoration:none;
    font-size:1.08rem;margin-left:8px;transition:box-shadow 0.2s;
  }
  .profile:hover {
    background:#4636e3;
    box-shadow:0 2px 8px rgba(70,54,227,0.10);
  }
  .products-grid {
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:32px;
    margin:32px 0;
  }
    .container {
      max-width:1200px;
      margin:40px auto 32px auto;
      padding:32px 32px 32px 32px;
      background:rgba(255,255,255,0.95);
      border-radius:18px;
      box-shadow:0 2px 16px rgba(70,54,227,0.07);
    }
  .product-card {
    background:#fff;
    border-radius:18px;
    box-shadow:0 4px 24px rgba(70,54,227,0.10);
    overflow:hidden;
    transition: transform 0.25s cubic-bezier(.4,0,.2,1), box-shadow 0.25s cubic-bezier(.4,0,.2,1);
    will-change: transform, box-shadow;
    position:relative;
  }
  .product-card:hover {
    transform: scale(1.045) translateY(-6px);
    box-shadow: 0 8px 32px rgba(70,54,227,0.18), 0 2px 8px rgba(0,0,0,0.10);
    z-index:2;
  }
  .recent-listing {
    background:#a78bfa;padding:6px 18px;color:#fff;font-weight:600;font-size:0.95rem;
    position:absolute;top:0;left:0;z-index:1;border-top-left-radius:18px;border-bottom-right-radius:12px;
  }
  .trade-btn-row {
    display: flex;
    gap: 18px;
    margin-bottom: 8px;
    justify-content: space-between;
  }
  .trade-btn {
    flex: 1 1 0;
    background:#4636e3;
    color:#fff;
    border:none;
    border-radius:8px;
    padding:10px 0;
    font-size:1.08rem;
    font-weight:500;
    cursor:pointer;
    transition: box-shadow 0.2s;
  }
  .trade-btn:hover {
    background:#0b63ff;
    box-shadow:0 2px 8px rgba(70,54,227,0.10);
  }
</style>
</head>
<body>
  <header>
    <div class="logo">RealEstate dApp</div>
    <div style="display:flex;align-items:center;gap:32px;">
      <nav style="display:flex;align-items:center;gap:24px;">
  <a href="index.html" class="nav-link">Home</a>
  <a href="marketplace.html" class="nav-link">Marketplace</a>
  <a href="profile.html" class="nav-link" id="profileBtn" style="display:none;">Profile</a>
  <a href="admin.html" class="nav-link" id="adminBtn" style="display:none;">Admin</a>
  <a href="about_us.html" class="nav-link">About Us</a>
  <a href="#" class="btn-login" id="loginBtn">Login</a>
  <a href="#" class="btn-login" id="logoutBtn" style="display:none;">Logout</a>
      </nav>
    </div>
  </header>
  <div class="container">
    <h2>Marketplace</h2>
    <div style="display:flex;gap:40px;align-items:flex-start;">
      <div style="flex:1;min-width:340px;">
        <h3 style="color:#4636e3;margin-bottom:18px;">Properties</h3>
        <div id="propertiesList"></div>
      </div>
      <div style="flex:1;min-width:340px;">
        <h3 style="color:#4636e3;margin-bottom:18px;">Trading Platform</h3>
        <div style="background:#fff;padding:24px;border-radius:16px;box-shadow:0 2px 12px rgba(70,54,227,0.07);">
          <label for="tradeProperty">Select Property:</label>
          <select id="tradeProperty" style="width:100%;padding:10px;margin-bottom:18px;border-radius:8px;border:1px solid #e6eefc;"></select>
          <div id="tradeDetails" style="margin-bottom:18px;"></div>
          <input id="tradeShares" type="number" min="1" placeholder="Number of shares" style="margin-bottom:12px;" />
          <div class="trade-btn-row">
            <button id="sellBtn" class="trade-btn">Sell Shares</button>
            <button id="buyBtn" class="trade-btn">Buy Shares</button>
          </div>
          <div id="tradeMsg" style="margin-top:18px;color:#4636e3;font-weight:500;"></div>
        </div>
      </div>
    </div>
  </div>
  <footer style="background:#fff;border-top:1px solid #e3e6fd;padding:24px 0;text-align:center;margin-top:48px;font-size:1.08rem;color:#444;">
    <div>&copy; 2025 RealEstate dApp. All rights reserved.</div>
  </footer>
  <script>
// Utility to record a trade (copied from admin.html)
function recordTrade({type, userId, propertyId, quantity, price}) {
  const trades = JSON.parse(localStorage.getItem('trades')||'[]');
  trades.push({
    id: trades.length+1,
    type, // 'buy' or 'sell'
    userId,
    propertyId,
    quantity,
    price,
    timestamp: new Date().toISOString()
  });
  localStorage.setItem('trades', JSON.stringify(trades));
}
// Load properties from localStorage or use Malaysia examples
function getProperties() {
  const props = JSON.parse(localStorage.getItem('properties')||'[]');
  return props;
}

function renderProperties() {
  const props = getProperties();
  const list = document.getElementById('propertiesList');
  list.innerHTML = props.map(p => `
    <div class="product-card" style="margin-bottom:24px;">
      <div class="recent-listing">RECENT LISTING</div>
      <img src="${p.image}" alt="${p.title}" style="width:100%;height:180px;object-fit:cover;">
      <div style="padding:18px 16px 10px 16px;">
        <div style="font-size:1.15rem;font-weight:600;color:#222;">${p.title}</div>
        <div style="font-size:0.98rem;color:#666;">${p.address}</div>
        <div style="color:#7c3aed;font-weight:600;margin-top:8px;">${p.rentalYield}% Rental Yield</div>
        <div style="color:#4636e3;font-size:0.98rem;">${p.annualReturn}% Projected Annual Return</div>
      </div>
      <div style="background:#a78bfa;color:#fff;padding:8px 0;text-align:center;font-size:1rem;font-weight:500;">Available: ${p.availableShares} shares at ${p.sharePrice} ETH</div>
    </div>
  `).join('');
}

function renderTradeDropdown() {
  const props = getProperties();
  const select = document.getElementById('tradeProperty');
  select.innerHTML = props.map((p,i) => `<option value="${i}">${p.title}</option>`).join('');
  renderTradeDetails(0);
  select.onchange = function() { renderTradeDetails(this.value); };
}

function renderTradeDetails(idx) {
  const props = getProperties();
  const p = props[idx];
  document.getElementById('tradeDetails').innerHTML = `
    <div><b>${p.title}</b></div>
    <div>${p.address}</div>
    <div>Rental Yield: <b>${p.rentalYield}%</b></div>
    <div>Annual Return: <b>${p.annualReturn}%</b></div>
    <div>Available Shares: <b>${p.availableShares}</b></div>
    <div>Share Price: <b>${p.sharePrice} ETH</b></div>
  `;
}

function buyShares() {
  const idx = document.getElementById('tradeProperty').value;
  const shares = Number(document.getElementById('tradeShares').value);
  const props = getProperties();
  const p = props[idx];
  if (!shares || shares < 1) return showTradeMsg('Enter valid number of shares.');
  if (shares > p.availableShares) return showTradeMsg('Not enough shares available.');

  // Check login
  const userStr = localStorage.getItem('currentUser');
  if (!userStr) {
    showTradeMsg('Please login to buy shares.');
    return;
  }

  // Reduce available shares
  p.availableShares -= shares;
  localStorage.setItem('properties', JSON.stringify(props));

  // Record ownership
  const user = JSON.parse(userStr);
  let ownership = JSON.parse(localStorage.getItem('ownership')||'[]');
  let owner = ownership.find(o=>o.userId===user.id && o.propertyId===p.id);
  if (owner) {
    owner.shares += shares;
  } else {
    ownership.push({userId:user.id,propertyId:p.id,shares:shares});
  }
  localStorage.setItem('ownership', JSON.stringify(ownership));

  // Record transaction
  let transactions = JSON.parse(localStorage.getItem('transactions')||'[]');
  transactions.push({
    id: transactions.length+1,
    type: 'buy',
    propertyId: p.id,
    userId: user.id,
    shares: shares,
    amount: Math.round(p.sharePrice*shares*10000)/10000,
    timestamp: new Date().toISOString()
  });
  localStorage.setItem('transactions', JSON.stringify(transactions));

  // Record trading history
  if (typeof recordTrade === 'function') {
    recordTrade({
      type: 'buy',
      userId: user.id,
      propertyId: p.id,
      quantity: shares,
      price: p.sharePrice
    });
  }
  showTradeMsg(`Purchased ${shares} shares of ${p.title}.`);
  renderProperties();
  renderTradeDetails(idx);
}

function sellShares() {
  const idx = document.getElementById('tradeProperty').value;
  const shares = Number(document.getElementById('tradeShares').value);
  const props = getProperties();
  const p = props[idx];
  if (!shares || shares < 1) return showTradeMsg('Enter valid number of shares.');

  // Validate user ownership
  const userStr = localStorage.getItem('currentUser');
  if (userStr) {
    const user = JSON.parse(userStr);
    let ownership = JSON.parse(localStorage.getItem('ownership')||'[]');
    let owner = ownership.find(o=>o.userId===user.id && o.propertyId===p.id);
    if (!owner || owner.shares < shares) {
      showTradeMsg('You do not have enough shares to sell.');
      return;
    }
    // Reduce user's shares
    owner.shares -= shares;
    localStorage.setItem('ownership', JSON.stringify(ownership));

    // Increase available shares
    p.availableShares += shares;
    localStorage.setItem('properties', JSON.stringify(props));

    // Record transaction
    let transactions = JSON.parse(localStorage.getItem('transactions')||'[]');
    transactions.push({
      id: transactions.length+1,
      type: 'sell',
      propertyId: p.id,
      userId: user.id,
      shares: shares,
      amount: Math.round(p.sharePrice*shares*10000)/10000,
      timestamp: new Date().toISOString()
    });
    localStorage.setItem('transactions', JSON.stringify(transactions));

    // Record trading history
    if (typeof recordTrade === 'function') {
      recordTrade({
        type: 'sell',
        userId: user.id,
        propertyId: p.id,
        quantity: shares,
        price: p.sharePrice
      });
    }
    showTradeMsg(`Sold ${shares} shares of ${p.title}.`);
    renderProperties();
    renderTradeDetails(idx);
// Load recordTrade from admin.html if available
if (typeof recordTrade !== 'function') {
  window.recordTrade = function(){};
}
  } else {
    showTradeMsg('Please login to sell shares.');
  }
}

function showTradeMsg(msg) {
  document.getElementById('tradeMsg').innerText = msg;
}

window.addEventListener('DOMContentLoaded', function() {
  renderProperties();
  renderTradeDropdown();
  document.getElementById('buyBtn').onclick = buyShares;
  document.getElementById('sellBtn').onclick = sellShares;
});
  function renderAuth() {
    const userStr = localStorage.getItem('currentUser');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const profileBtn = document.getElementById('profileBtn');
    const adminBtn = document.getElementById('adminBtn');
    if (userStr) {
      const user = JSON.parse(userStr);
      loginBtn.style.display = 'none';
      logoutBtn.style.display = '';
      if (user.isAdmin) {
        adminBtn.style.display = '';
        profileBtn.style.display = 'none';
      } else {
        adminBtn.style.display = 'none';
        profileBtn.style.display = '';
      }
    } else {
      loginBtn.style.display = '';
      logoutBtn.style.display = 'none';
      profileBtn.style.display = 'none';
      adminBtn.style.display = 'none';
    }
  }

  document.getElementById('loginBtn').addEventListener('click', function(e) {
    e.preventDefault();
    window.location.href = 'login.html';
  });

  document.getElementById('logoutBtn').addEventListener('click', function(e) {
    e.preventDefault();
    localStorage.removeItem('currentUser');
    renderAuth();
    window.location.reload();
  });

  window.addEventListener('DOMContentLoaded', renderAuth);
  </script>
</body>
</html>